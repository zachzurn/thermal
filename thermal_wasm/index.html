<!doctype html>
<html lang="en-US">
<head>
    <meta charset="utf-8"/>
    <title>hello-wasm example</title>
</head>
<body>

<style>

    body {
        background-color: black;
    }

    section {
        padding: 40px;
        display: flex;
        gap: 25px;
        height: calc(100vh - 97px);
    }

    textarea {
        width: 100%;
        background: #090909;
        border: none;
        color: #a4a3a3;
        font-family: sans-serif;
        box-sizing: border-box;
        border-radius: 5px;
        padding: 25px;
        line-height: 22px;
        height: 88vh;
        border: 1px solid transparent;
        resize: none;
    }

    textarea:focus {
        outline: none !important;
        border: 1px solid #232323;
    }

    .editor {
        display: flex;
        flex-grow: 1;
    }

    .preview {
        overflow-y: auto;
        width: 450px;
        padding-left: 5px;
        padding-right: 5px;
        overflow-x: hidden;
    }

    canvas {
        max-width: 100%;
    }

    /* Chrome, Edge and Safari */
    *::-webkit-scrollbar {
        height: 7px;
        width: 7px;
    }

    *::-webkit-scrollbar-track {
        border-radius: 5px;
        background-color: #000000;
    }

    *::-webkit-scrollbar-track:hover {
        background-color: #000000;
    }

    *::-webkit-scrollbar-track:active {
        background-color: #000000;
    }

    *::-webkit-scrollbar-thumb {
        border-radius: 5px;
        background-color: #6B6B6B;
    }

    *::-webkit-scrollbar-thumb:hover {
        background-color: #6B6B6B;
    }

    *::-webkit-scrollbar-thumb:active {
        background-color: #6B6B6B;
    }

</style>

<section>
    <div class="editor">
        <textarea id="thermal_code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
'// ============================================================================
'// Issuing receipts with barcodes
'// ============================================================================

'// --- Initial setting --->>>
'// Initialize printer
    ESC "@"
'// Set horizontal tab positions: 35th column
    ESC "D" 35 0
'// Set horizontal and vertical motion units: Horizontal motion unit = 0.141 mm
'// (1/180 inch), vertical motion unit = 0.141 mm (1/180 inch)
    GS "P" 180 180

'// Set graphics data: [Function 83] Define the download graphics data
'// (raster format)
'// Define data that is 30*8 dots wide and 40 dots high with respect to key code
'// "A1"
'// GS ( L   pL  pH   m  fn  a  kc1/Kc2  b  xL  xH  yL  yH   c
    GS "(L" 187   4  48  83 48   "A1"    1 240   0  40   0  49
'//      1    2    3    4    5    6    7    8    9   10   11   12   13   14   15
'//     16   17   18   19   20   21   22   23   24   25   26   27   28   29   30
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x18 0x00 0x60 0x1F 0xE0 0x18 0x00 0x61 0xFF 0xF0 0x00 0x03 0xFF 0xE0
      0x3F 0xFF 0xC0 0x3F 0xC0 0x3F 0xFF 0xC1 0xF0 0x7F 0xFC 0x07 0xFF 0xF8 0x03
      0xC0 0x18 0x00 0x60 0x3F 0xF0 0x18 0x00 0x61 0xFF 0xF8 0x00 0x03 0xFF 0xF0
      0x3F 0xFF 0xC0 0x7F 0xE0 0x3F 0xFF 0xC1 0xF0 0x7F 0xFE 0x07 0xFF 0xF8 0x03
      0xC0 0x0C 0x00 0xC0 0x70 0x38 0x18 0x00 0x61 0x80 0x1C 0x00 0x03 0x00 0x38
      0x30 0x00 0x00 0xE0 0x70 0x30 0x00 0x00 0xC0 0x60 0x07 0x00 0x0C 0x00 0x03

      0xC0 0x0C 0x00 0xC0 0x60 0x18 0x18 0x00 0x61 0x80 0x0E 0x00 0x03 0x00 0x1C
      0x30 0x00 0x00 0xC0 0x38 0x30 0x00 0x00 0xC0 0x60 0x03 0x80 0x0C 0x00 0x03
      0xC0 0x06 0x01 0x80 0xE0 0x1C 0x18 0x00 0x61 0x80 0x06 0x00 0x03 0x00 0x0C
      0x30 0x00 0x01 0xC0 0x18 0x30 0x00 0x00 0xC0 0x60 0x01 0x80 0x0C 0x00 0x03
      0xC0 0x06 0x01 0x80 0xC0 0x0C 0x18 0x00 0x61 0x80 0x06 0x00 0x03 0x00 0x0C
      0x30 0x00 0x01 0x80 0x0C 0x30 0x00 0x00 0xC0 0x60 0x01 0x80 0x0C 0x00 0x03
      0xC0 0x03 0x03 0x00 0xC0 0x0C 0x18 0x00 0x61 0x80 0x06 0x00 0x03 0x00 0x0C
      0x30 0x00 0x03 0x80 0x0C 0x30 0x00 0x00 0xC0 0x60 0x01 0x80 0x0C 0x00 0x03
      0xC0 0x03 0x03 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0x06 0x00 0x03 0x00 0x0C
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x01 0x80 0x0C 0x00 0x03
      0xC0 0x01 0x86 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0x06 0x00 0x03 0x00 0x0C
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x01 0x80 0x0C 0x00 0x03
      0xC0 0x01 0x86 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0x0E 0x00 0x03 0x00 0x1C
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x03 0x80 0x0C 0x00 0x03
      0xC0 0x00 0xCC 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0x1C 0x00 0x03 0x00 0x38
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x07 0x00 0x0C 0x00 0x03
      0xC0 0x00 0xCC 0x01 0x80 0x06 0x18 0x00 0x61 0xFF 0xF8 0x00 0x03 0xFF 0xF0
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x7F 0xFE 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x78 0x01 0x80 0x06 0x18 0x00 0x61 0xFF 0xF0 0x00 0x03 0xFF 0xE0
      0x3F 0xFF 0x83 0x00 0x00 0x3F 0xFF 0x80 0xC0 0x7F 0xFC 0x00 0x0C 0x00 0x03

      0xC0 0x00 0x78 0x01 0x80 0x06 0x18 0x00 0x61 0x83 0x00 0x00 0x03 0x06 0x00
      0x3F 0xFF 0x83 0x00 0x00 0x3F 0xFF 0x80 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x01 0x80 0x06 0x18 0x00 0x61 0x81 0x80 0x00 0x03 0x03 0x00
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x01 0x80 0x06 0x18 0x00 0x61 0x81 0x80 0x00 0x03 0x03 0x00
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0xC0 0x00 0x03 0x01 0x80
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0xC0 0x00 0x03 0x01 0x80
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x01 0x80 0x06 0x18 0x00 0x61 0x80 0x60 0x00 0x03 0x00 0xC0
      0x30 0x00 0x03 0x00 0x00 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0xC0 0x0C 0x18 0x00 0x61 0x80 0x60 0x00 0x03 0x00 0xC0
      0x30 0x00 0x01 0x80 0x0C 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0xC0 0x0C 0x1C 0x00 0xE1 0x80 0x30 0x00 0x03 0x00 0x60
      0x30 0x00 0x01 0x80 0x0C 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0xE0 0x1C 0x0C 0x00 0xC1 0x80 0x30 0x00 0x03 0x00 0x60
      0x30 0x00 0x01 0xC0 0x18 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0x60 0x18 0x0E 0x01 0xC1 0x80 0x18 0x00 0x03 0x00 0x30
      0x30 0x00 0x00 0xC0 0x38 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03

      0xC0 0x00 0x30 0x00 0x70 0x38 0x07 0x03 0x81 0x80 0x1C 0x00 0x03 0x00 0x38
      0x30 0x00 0x00 0xE0 0x70 0x30 0x00 0x00 0xC0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0x3F 0xF0 0x03 0xFF 0x01 0x80 0x0E 0x00 0x03 0x00 0x1C
      0x3F 0xFF 0xC0 0x7F 0xE0 0x3F 0xFF 0xC1 0xF0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x30 0x00 0x1F 0xE0 0x01 0xFE 0x01 0x80 0x0E 0x00 0x03 0x00 0x1C
      0x3F 0xFF 0xC0 0x3F 0xC0 0x3F 0xFF 0xC1 0xF0 0x60 0x00 0x00 0x0C 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
      0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
'// --- Initial setting ---<<<


'// --- Print stamp --->>>
'// Select justification: Centering
    ESC "a" 1

'// Set graphics data: [Function 85] Print the specified download graphics data
'// Print the download graphics that correspond to key code "A1" with same width
'// and double-height characters
'// GS ( L   pL  pH   m  fn Kc1/Kc2 x y
    GS "(L"   6   0  48  85  "A1"   1 2

'// Print and feed paper: Paper feeding amount = 1.13 mm (8/180 inches)
    ESC "J" 8
'// Text data and print and line feed
    "Thank you" LF
    "NOVEMBER 1, 2012 15:00"
'// Print and feed n lines: Feed the paper three lines
    ESC "d" 3
'// --- Print stamp ---<<<


'// --- Print details --->>>
'// Select justification: Left justification
    ESC "a" 0
'// Detail text data and horizontal tab, print and line feed
    "TM-Hxxx" HT "  6.00" LF
    "PS-xxx"  HT "  1.70" LF LF
'// Select character size: (horizontal (times 1) x vertical (times 2))
    GS "!" 0x01
'// Detail text data and horizontal tab, print and line feed
    "TOTAL" HT "  7.70" LF
'// Select character size: Normal size
    GS "!" 0x00
'// Detail text data and horizontal tab, print and line feed
    "------------------------------------------" LF
    "PAID"   HT " 10.00" LF
    "CHANGE" HT "  2.30"
'// Print and feed n lines: Feed the paper three lines
    ESC "d" 3
'// --- Print details ---<<<


'// --- Print barcode --->>>
'// Select justification: Centering
    ESC "a" 1
    "<< Bonus points : 14 >>"
'// Print and feed paper: Paper feeding amount = 4.94 mm (35/180 inches)
    ESC "J" 35
'// Set barcode height: in case TM-T20, 6.25 mm (50/203 inches)
    GS "h" 50
'// Select print position of HRI characters: Print position, below the barcode
    GS "H" 2
'// Select font for HRI characters: Font B
    GS "f" 1
'// Print barcode: (A) format, barcode system = CODE39
    GS "k" 4 "*00014*" 0
'// --- Print barcode ---<<<


'// Select cut mode and cut paper: [Function B] Feed paper to
'// (cutting position + 4.23 mm (30/203 inches)) and executes a partial cut
'// (one point left uncut).
    GS "V" 66 30
        </textarea>
    </div>
    <div class="preview">
        <canvas id="thermal_preview" width="1" height="1" style="border:1px solid #d3d3d3;"
                style="display: none;"></canvas>
    </div>
</section>

<script type="module">
    import init, {render_to_canvas} from "./pkg/thermal_wasm.js";

    const textarea = document.getElementById("thermal_code");
    const canvas = document.getElementById("thermal_preview");

    let rendering = false;
    let changed = false;

    function debounce(func, wait, immediate) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            var later = function () {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }

    function try_render() {
        if (rendering) {
            return false;
        }
        changed = false;

        new Promise((resolve, reject) => {
            render_to_canvas(textarea.value, canvas);

            canvas.style.display = "block";
            rendering = false;

            if (changed) {
                try_render();
            }
        });
    }

    init().then(() => {
        changed = true;
        try_render();

        textarea.addEventListener('input', debounce(try_render, 300), false);
    });
</script>
</body>
</html>